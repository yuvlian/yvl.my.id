<!DOCTYPE html>
<html lang="en">
 
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>presensi</title>
    <meta property="og:title" content="Presensi">
    <meta property="og:description" content="An alternative frontend for Airlangga University's presence system.">
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
            background: #f2f2f2;
        }

        .box {
            max-width: 500px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
        }

        input,
        button,
        select {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 16px;
        }

        button {
            background: #006cff;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:disabled {
            background: #999;
            cursor: not-allowed;
        }

        label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        #video {
            width: 100%;
            margin-top: 10px;
            display: none;
        }

        .notify {
            margin-top: 15px;
            padding: 15px;
            border-left: 5px solid;
            border-radius: 6px;
            font-size: 15px;
        }

        .notify-ok {
            background: #e8ffe8;
            border-color: #00b300;
            color: #003d00;
        }

        .notify-warn {
            background: #fff7d6;
            border-color: #ffc400;
            color: #5a4b00;
        }

        .notify-error {
            background: #ffe5e5;
            border-color: #ff0000;
            color: #7a0000;
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .box {
                padding: 15px;
            }

            input,
            button,
            select {
                font-size: 15px;
            }
        }
    </style>
</head>

<body>
    <noscript>
        <div class="box notify notify-error">
            JavaScript is required to use this page. Please enable it.
        </div>
        <br>
    </noscript>

    <div class="box">
        <h2 id="presensititle">Presensi</h2>
        <label for="presensititle">Alternative frontend for Airlangga check-in.</label>
        <label for="presensititle">Tysm @amizing25 for helping me :&gt;</label>
        <hr style="margin:20px 0;opacity:0.3;">

        <h3>Login</h3>
        <label for="mode">Select Identification Method:</label>
        <select id="mode" onchange="switchMode()">
            <option value="id" selected>ID_MHS</option>
            <option value="userpass">Email + Password</option>
        </select>

        <div id="userpass_box" style="display:none;">
            <input id="username" placeholder="Email" />
            <input id="password" type="password" placeholder="Password" />
        </div>

        <div id="id_box" style="display:block;">
            <input id="id_mhs" placeholder="ID MHS" />
        </div>

        <hr style="margin:20px 0;opacity:0.3;">

        <h3 id="positiontitle">Position</h3>
        <label for="positiontitle">You can leave these empty, I think?</label>
        <input id="longitude" placeholder="Longitude" />
        <input id="latitude" placeholder="Latitude" />
        <div id="loc_status" style="font-size:14px;color:#666;margin-top:4px;display:none;">Getting your location...
        </div>
        <button onclick="getLocation()">Or, get it from your location</button>

        <hr style="margin:20px 0;opacity:0.3;">

        <h3>Class ID</h3>
        <input id="qr_text" placeholder="Class ID" />
        <button id="start-qr-button" onclick="startQR()">Or, scan a QR code with your camera</button>
        <div id="qr-camera-interface" style="display: none;">
            <label for="camera-select">Select Camera:</label>
            <select id="camera-select"></select>
            <video id="video"></video>
            <label for="video" id="qr_status" style="display: none;"></label>
        </div>
        <input type="file" id="qr_image_input" accept="image/*" style="display:none;">
        <button onclick="document.getElementById('qr_image_input').click()">Or, scan a QR code image file</button>

        <hr style="margin:20px 0;opacity:0.3;">
        <button id="checkin_button" onclick="sendData()">Check-In</button>
        <label for="checkin_button">Check-In automatically runs when you scan a QR or input Class ID manually.</label>
    </div>

    <div id="notify_container" style="max-width:500px;margin:20px auto;"></div>

    <script type="module">
        const startQrButton = document.getElementById('start-qr-button');
        const cameraInterface = document.getElementById('qr-camera-interface');
        const cameraSelect = document.getElementById('camera-select');

        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        window.addEventListener("DOMContentLoaded", () => {
            switchMode();
            document.getElementById('qr_image_input').addEventListener('change', scanImageQR);

            const qrTextInput = document.getElementById('qr_text');
            qrTextInput.addEventListener('input', debounce(() => {
                if (qrTextInput.value.trim() !== '') {
                    document.getElementById("notify_container").innerHTML = "";
                    notify(1, "Checking in in 2 seconds...");
                    setTimeout(window.sendData, 2000);
                }
            }, 1000));
        });

        import QrScanner from "https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js";

        let scanner;
        let isSendingData = false;

        // this is just cloudflare's forward proxy for avoiding CORS issues
        const PROXY_HOST = "proxy2.neonteam.dev";
        const HOST_KAMPUS_KITA = "apikampuskita-mahasiswa.unair.ac.id";
        const HOST_CYBER_CAMPUS = "apicybercampus.unair.ac.id";

        function notify(level, msg) {
            const cont = document.getElementById("notify_container");
            const div = document.createElement("div");

            let cls = "notify ";
            if (level === 0) cls += "notify-ok";
            else if (level === 1) cls += "notify-warn";
            else cls += "notify-error";

            div.className = cls;
            div.innerHTML = msg;
            cont.appendChild(div);
        }

        function setCheckinButtonState(isProcessing) {
            const btn = document.getElementById('checkin_button');
            btn.disabled = isProcessing;
            btn.textContent = isProcessing ? 'Check-In (Processing...)' : 'Check-In';
        }

        function resetSendingState() {
            isSendingData = false;
            setCheckinButtonState(false);
        }

        window.switchMode = function () {
            const mode = document.getElementById('mode').value;
            document.getElementById('userpass_box').style.display = mode === 'userpass' ? 'block' : 'none';
            document.getElementById('id_box').style.display = mode === 'id' ? 'block' : 'none';
        };

        window.getLocation = function () {
            document.getElementById("notify_container").innerHTML = "";
            const status = document.getElementById('loc_status');
            status.style.display = 'block';
            status.textContent = 'Getting your location...';

            navigator.geolocation.getCurrentPosition(pos => {
                document.getElementById('longitude').value = pos.coords.longitude;
                document.getElementById('latitude').value = pos.coords.latitude;
                status.textContent = 'Location received.';
                notify(0, "Location received");
                setTimeout(() => status.style.display = 'none', 1500);
            }, () => {
                notify(2, "Failed to get your location.");
                status.style.display = 'none';
            });
        };

        async function setupZoomSlider() {
            if (!scanner || !scanner.$video) return;
            
            const existingSlider = document.getElementById('zoom_slider');
            if (existingSlider) existingSlider.remove();

            const stream = scanner.$video.srcObject;
            if (!stream) return;

            const track = stream.getVideoTracks()[0];
            if (!track) return;

            const capabilities = track.getCapabilities();
            if (!capabilities.zoom) {
                notify(1, "Camera does not report zoom capability.");
                return;
            }

            const video = document.getElementById('video');
            const slider = document.createElement("input");
            slider.type = "range";
            slider.min = capabilities.zoom.min;
            slider.max = capabilities.zoom.max;
            slider.step = capabilities.zoom.step || 0.01;
            slider.value = capabilities.zoom.min;
            slider.id = "zoom_slider";
            slider.style.width = "100%";
            slider.style.margin = "10px 0";
            video.insertAdjacentElement("afterend", slider);
            slider.oninput = async () => {
                await track.applyConstraints({
                    advanced: [{ zoom: parseFloat(slider.value) }]
                });
            };
        }

        function handleCameraChange(event) {
            const status = document.getElementById('qr_status');
            status.textContent = 'Switching camera...';
            scanner.setCamera(event.target.value).then(() => {
                status.textContent = 'Scanning...';
                setupZoomSlider();
            }).catch(err => {
                notify(2, `Failed to switch camera: ${err}`);
            });
        }

        window.startQR = async function () {
            document.getElementById("notify_container").innerHTML = "";

            if (startQrButton) startQrButton.style.display = 'none';
            if (cameraInterface) cameraInterface.style.display = 'block';

            const video = document.getElementById('video');
            const status = document.getElementById('qr_status');

            if (scanner) {
                video.style.display = 'block';
                status.style.display = 'block';
                status.textContent = 'Scanning...';
                await scanner.start();
                return;
            }

            status.style.display = 'block';
            status.textContent = 'Starting camera...';
            video.style.display = 'block';

            try {
                scanner = new QrScanner(
                    video,
                    result => {
                        status.textContent = 'QR detected. Checking In...';
                        document.getElementById('qr_text').value = result.data || result;

                        notify(0, "QR detected:<br><pre>" +
                            (typeof result === "object" ? JSON.stringify(result, null, 2) : String(result)) +
                            "</pre>");

                        scanner.stop();

                        video.style.display = 'none';
                        status.style.display = 'none';
                        if (cameraInterface) cameraInterface.style.display = 'none';
                        if (startQrButton) startQrButton.style.display = 'block';

                        const slider = document.getElementById('zoom_slider');
                        if (slider) slider.remove();

                        setTimeout(() => {
                            status.style.display = 'none';
                            video.style.display = 'none';
                        }, 1200);

                        window.sendData();
                    },
                    {
                        onDecodeError: err => {
                            if (!String(err).includes("No QR code found")) {
                                notify(2, `QR Decode error: ${err}`);
                            }
                        },
                        returnDetailedScanResult: true,
                        maxScansPerSecond: 10,
                        highlightScanRegion: true,
                    }
                );

                await scanner.start();
                status.textContent = 'Scanning...';

                if (cameraSelect.options.length === 0 || cameraSelect.options[0].value === "") {
                    const cameras = await QrScanner.listCameras(true);

                    if (cameras.length === 0) {
                        cameraSelect.innerHTML = '<option value="">No cameras found</option>';
                        notify(2, "No cameras found on this device.");
                        return;
                    }

                    cameras.forEach((camera, index) => {
                        const option = document.createElement('option');
                        option.text = camera.label || `Camera ${index + 1}`;
                        option.value = camera.id;
                        cameraSelect.appendChild(option);
                    });

                    cameraSelect.removeEventListener('change', handleCameraChange);
                    cameraSelect.addEventListener('change', handleCameraChange);
                }
                await setupZoomSlider();
            } catch (err) {
                notify(2, `QR init error: ${err}`);
                status.style.display = 'none';
                video.style.display = 'none';
                if (cameraInterface) cameraInterface.style.display = 'none';
                if (startQrButton) startQrButton.style.display = 'block';
            }
        };

        window.scanImageQR = async function () {
            document.getElementById("notify_container").innerHTML = "";
            const imageInput = document.getElementById('qr_image_input');

            if (imageInput.files.length === 0) return;

            const file = imageInput.files[0];
            const status = document.getElementById('qr_status');

            if (scanner) {
                scanner.stop();
            }
            document.getElementById('video').style.display = 'none';
            const slider = document.getElementById('zoom_slider');
            if (slider) slider.remove();

            if (cameraInterface) cameraInterface.style.display = 'none';
            if (startQrButton) startQrButton.style.display = 'block';

            status.style.display = 'block';
            status.textContent = `Scanning image: ${file.name}...`;

            try {
                const result = await QrScanner.scanImage(file, {
                    setAlsoTryWithoutScanRegion: true,
                    returnDetailedScanResult: true
                });

                document.getElementById('qr_text').value = result.data;
                status.textContent = 'Image QR detected. Checking In...';
                notify(0, `Image QR detected:<br><pre>${result.data}</pre>`);

                window.sendData();
            } catch (error) {
                if (error) {
                    notify(2, `Failed to scan image: ${error}`);
                } else {
                    notify(1, 'No QR code found in the image.');
                }
            } finally {
                imageInput.value = '';
                setTimeout(() => status.style.display = 'none', 2000);
            }
        };

        async function fetchCyberToken() {
            const url = `https://${PROXY_HOST}/${HOST_CYBER_CAMPUS}/api/token/ambil-token-v2`;

            const body = new URLSearchParams({
                user: "apps",
                key: "aPiUntuKapps@4ndRo!D_20211210"
            });

            try {
                const resp = await fetch(url, {
                    method: "POST",
                    headers: {
                        "content-type": "application/x-www-form-urlencoded;charset=UTF-8",
                        "accept": "application/json"
                    },
                    body: body.toString()
                });
                return await resp.json();
            } catch {
                notify(2, "Failed to get CyberCampus token.");
                return null;
            }
        }

        window.sendData = async function () {
            if (isSendingData) {
                notify(1, "Check-in request already in progress. Please wait.");
                return;
            }

            isSendingData = true;

            document.getElementById("notify_container").innerHTML = "";
            notify(1, "Starting Check-in process...");

            setCheckinButtonState(true);

            const mode = document.getElementById('mode').value;
            let id_mhs = "";

            if (scanner) {
                scanner.stop();
            }
            document.getElementById('video').style.display = 'none';
            document.getElementById('qr_status').style.display = 'none';
            if (cameraInterface) cameraInterface.style.display = 'none';
            if (startQrButton) startQrButton.style.display = 'block';

            const slider = document.getElementById('zoom_slider');
            if (slider) slider.remove();

            if (mode === "userpass") {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                if (!username || !password) {
                    resetSendingState();
                    return notify(1, "Username and password must not be empty.");
                }

                const loginUrl = `https://${PROXY_HOST}/${HOST_KAMPUS_KITA}/auth/login`;
                const formBody = new URLSearchParams({ email: username, password: password });

                let loginResp;
                try {
                    loginResp = await fetch(loginUrl, {
                        method: "POST",
                        headers: {
                            "content-type": "application/x-www-form-urlencoded;charset=UTF-8",
                            "accept": "application/json"
                        },
                        body: formBody.toString()
                    }).then(r => r.json());
                } catch {
                    resetSendingState();
                    return notify(2, "Failed to login to Kampus Kita.");
                }

                id_mhs = loginResp?.data?.mahasiswa?.ID_MHS;
                if (!id_mhs) {
                    resetSendingState();
                    return notify(2, "Login failed. Check your credentials.");
                }
                notify(0, "Logged in. You can use this ID_MHS next time: " + id_mhs);
            } else {
                id_mhs = document.getElementById('id_mhs').value;
                if (!id_mhs) {
                    resetSendingState();
                    return notify(1, "ID_MHS must not be empty.");
                }
            }

            const classId = document.getElementById('qr_text').value;
            if (!classId) {
                resetSendingState();
                return notify(1, "Class ID must not be empty.");
            }
            const parts = classId.split("::");
            if (
                parts.length < 2 ||
                parts[0].trim() === "" ||
                parts[1].trim() === ""
            ) {
                resetSendingState();
                return notify(1, "Invalid Class ID format. Expected something like: XXXX::YYYY...");
            }

            const longitude = document.getElementById('longitude').value;
            const latitude = document.getElementById('latitude').value;

            const tokenData = await fetchCyberToken();
            if (!tokenData) {
                resetSendingState();
                return notify(2, "Invalid CyberCampus token.");
            }

            const presensiUrl = `https://${PROXY_HOST}/${HOST_CYBER_CAMPUS}/api/mahasiswa/presensi`;

            const presensiBody = new URLSearchParams({
                token: tokenData,
                id_mhs: id_mhs,
                id_presensi_kelas: classId,
                lang: longitude,
                lat: latitude
            });
            let result;
            try {
                result = await fetch(presensiUrl, {
                    method: "POST",
                    headers: {
                        "content-type": "application/x-www-form-urlencoded;charset=UTF-8",
                        "accept": "application/json"
                    },
                    body: presensiBody.toString()
                });
            } catch {
                resetSendingState();
                return notify(2, "Failed to send attendance data.");
            }
            const resS = await result.text();

            notify(0, `Check-In done! API Response: ${resS}`);
            resetSendingState();
        };
    </script>
</body>

</html>
